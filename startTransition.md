https://github.com/reactwg/react-18/discussions/41

初稿:2011/06/11

# 新機能: startTransition

## 概要

React18で新しいAPIをします。このAPIは大きな画面更新の間もアプリケーションをレスポンシブにし続けやすくします。この新しいAPIは特定の更新を「transitions」と印をつけることで、ユーザーインタラクションを大幅に改善します。Reactは状態遷移中に視覚的なフィードバックを与えたり、遷移中にブラウザがレスポンシブなままにします（responsive: 反応がある、モバイルデザインの文脈ではない）。



## `startTransition`が解決する問題とは？

動きがなめらかでレスポンシブなアプリケーションを作るのは必ずしも簡単ではありません。ボタンをクリックしたり、インプットに打鍵したりという小さな動作が画面上で多くのことを引き起こすことがあります。そうすると、全ての作業が行われている間、ページがフリーズやハングアップする可能性があります。

たとえば、データのリストをフィルターする入力フィールドに打鍵することを考えます。データをフィルターし、その入力の値をコントロールするできるように、フィールドの値をステートに保存する必要があります。

```javascript
// Update the input value and search results
setSearchQuery(input);
```

このときユーザーが文字を打鍵するたびに、入力値を更新し、新しい値を使ってリストを検索し、結果を表示します。大きな画面更新の場合、全てがレンダリングされる間、この処理はページのラグを発生させ、結果として入力や他のインタラクションが遅く、反応が悪いように感じさせます。リストがそこまで長くない場合でも、リストの中身自体が複雑であったり、キー操作のたびに項目が異なることがあり、そのレンダリングを最適化する明確な方法が存在しないことがありえます。

概念的には、問題の所在は2つの異なる更新を起こす必要があるということです。1つ目の更新は緊急性の高いもので、入力フィールドの値を変更し、その周辺のUIも変更する可能性があります。2つ目の更新は検索結果を更新するための比較的緊急性の低い更新です。

```javascript
// Urgent: Show what was typed
setInputValue(input);

// Not urgent: Show the results
setSearchQuery(input);
```

ユーザーは1つ目の更新はすぐに行われることを期待します。なぜならネイティブブラウザがこれらを高速に処理しているからです。しかしユーザーは2つ目の更新は多少遅れるかもしれないと考えています。ユーザーはこれがすぐに完了するとは思っていませんが、処理が多い可能性があるため構いません。（実際、開発者はでバウンスなどの技術で、このような更新を人工的に遅らせることがあります。）

React18までは、すべての更新はすぐに更新されていました。つまり、これら2つのステートは同時にレンダーされ、ユーザーは全てがレンダーされるまでインタラクションのフィードバックを見られないということです。私達に足りないのは、どのアップデートが緊急で、どのアップデートがそうでないかをReactに伝える方法です。

## `startTransition`はどう役に立つのか？

`startTransition` API は、更新に「遷移」として印をつけられるようにすることで、この問題を解決します。

```javascript
import { startTransition } from 'react';


// Urgent: Show what was typed
setInputValue(input);

// Mark any state updates inside as transitions
startTransition(() => {
  // Transition: Show the results
  setSearchQuery(input);
});
```

`startTransition`で包まれた更新は緊急でないものとして扱われ、クリックやキー押下といった相対的に緊急性の高い更新が現れると、この更新は中断されます。もし遷移がユーザーによって中断（たとえば、連続して文字をうつことで）されたら、Reactは未完了の古いレンダリング作業を捨て、最新の更新だけをレンダーします。

トランジションを使用すると、UIの大幅な変更を伴うような場合でも、ほとんどのインタラクションを簡潔に保つことができます。また、不要となったレンダリングで時間を取られることもありません。



## 遷移とはなにか？

我々は状態の更新を2つのカテゴリーの分類しています。

- **緊急度の高い更新**はタイピングやホバー、ドラッグなどの直接的なインタラクションを反映します
- **遷移更新**はUIをあるビューから別のビューへと変更させます

クリック、ホバー、スクロール、タイピングのような緊急度の高い更新は、物体がどのように振る舞うかについての我々の直感に合うように、即座に反応する必要があります。そうでなければ、「間違っている」という感じを与えるでしょう。

たとえば、ドロップダウンでフィルターを選択する時に、クリックするとすぐフィルターボタン自体が反応することを期待します。しかし、実際の結果は別々に推移することがあります。多少の遅れは知覚できないでしょうし、よくあるものだと思われています。もし結果がレンダリングされている以前にフィルターを再度変更するなら、最新の結果がみえること以外を気にする必要はありません。

典型的なReactアプリケーションでは、多くの更新が遷移的な更新です。しかし後方互換性のために遷移はopt-inです。デフォルトでは、React18は更新を緊急のものとして扱い、`startTransition`でくるむことで更新を遷移として印をつけることができます。



## `setTimeout`とどう違うか？

上記の問題のよくある解決策は、二番目の更新を`setTimeout`で包むことです。

```javascript
// Show what you typed
setInputValue(input);

// Show the results
setTimeout(() => {
  setSearchQuery(input);
}, 0);
```

これは二番目の更新を、一番目の更新がレンダーされる後まで遅らせます。スロットリングやでバウンシングはこのテクニックの一般的なバリエーションです。

重要な違いは、`startTransition`は`setTimeout`のように後にスケジュールされていないことです。`startTransition`は直ちに実行されます。`startTransition`に渡された関数は同期的に実行されますが、関数内のアップデートはどれも「遷移」と印がつけられます。Reactは更新を処理するときにこの情報を用いて、更新をレンダーする方法を決定します。つまり、タイムアウトで包まれている場合よりも早く、更新のレンダリングを開始します。高速なデバイスでは、2つの更新の差はほとんどないでしょう。遅いデバイスでは遅延は増えますが、UIはレスポンシブのままです。

もう一つの重要な違いは、`setTimeout`内の大規模な画面更新はタイムアウト後にページをロックしてしまうことです[just later... あたり謎]。もしユーザーがまだ入力していたりページを操作していれば、ユーザーはまだページとの対話[操作]をブロックされます。しかし`startTransition`と印がついたstate更新は中断可能で、ページをロックすることはありません。これにより、ブラウザは異なるコンポーネントのレンダリングする間の僅かな隙間でイベントを処理できます。もしユーザーの入力が変われば、もはやユーザーが興味のないものをレンダリングする必要はないでしょう。

つまり、`setTimeout`は更新を遅らせるので、ローディングインディケーターを出すには非同期コードを書く必要があり、そのコードはしばしば脆いです。遷移を使うと、Reactが保留状態を追跡し、遷移の現在の状態に基づいて更新し、待っている間にローディングフィードバックを表示することもできます。

## 遷移が保留されている間、どうすればいいか？


ベストプラクティスなので、バックグランドで作業が行われていることをユーザーに伝えたいでしょう。そのために、遷移の`isPending`フラグをもったHookを用意しています。

```javascript
import { useTransition } from 'react';


const [isPending, startTransition] = useTransition();
```

この`isPending`という値は遷移が保留されている間`true`であり、ユーザーが待機している間インラインスピナーの表示を可能にします。

```javascript
{isPending && <Spinner />}
```

遷移でくるんだstate更新は同じコンポーネントに由来する必要はありません。たとえば、検索入力内のスピナーは検索結果の再レンダリングの進捗状況を反映してもよいです。

## 速いコードを書きませんか？

速いコードを書き、不必要な再レンダリングを除くことはパフォーマンスを最適化するずっとよい方法です。遷移はそれを補うものです。遷移を使うことで、視覚的に大きく変化する際もUIをレスポンシブに保てますーーたとえば新しい画面を見せるときのように。これは既存の戦略では難しいです。不必要な再レンダリングがない場合でも、遷移はすべてのアップデートを緊急のものとして扱うよりも良いユーザーエクスペリエンスを提供します。

## どこで使える？

`startTransition`を使って、バックグラウンドに移動させたいあらゆるアップデートをラップすることができます。一般的に、この種の更新は2つのカテゴリーに分類されます。

- 遅いレンダリング：更新に時間がかかるのは、結果を表示するためにUIを遷移するために多くの作業を行う必要があるためです。
- 遅いネットワーク：更新に時間がかかるのは、Reactがネットワークのデータを待っているからです。この使用法はSuspenseと一体化しています。

近日中に、それぞれのユースケースを具体的な例を挙げてご紹介する予定です。ご質問がございましたら、お気軽にお問い合わせください。













